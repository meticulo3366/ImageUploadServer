var DbCommand = require('../commands/db_command').DbCommand
<<<<<<< HEAD
  // , ReplSet = require('../connection/repl_set/repl_set').ReplSet
  , utils = require('../utils')
  , crypto = require('crypto');
=======
  , utils = require('../utils');
>>>>>>> ce8810f9c11abc01d5c480f77f8827e1e3635323

var authenticate = function(db, username, password, authdb, options, callback) {
  var numberOfConnections = 0;
  var errorObject = null;
<<<<<<< HEAD
  var numberOfValidConnections = 0;
  var credentialsValid = false;
=======
>>>>>>> ce8810f9c11abc01d5c480f77f8827e1e3635323

  if(options['connection'] != null) {
    //if a connection was explicitly passed on options, then we have only one...
    numberOfConnections = 1;
  } else {
    // Get the amount of connections in the pool to ensure we have authenticated all comments
    numberOfConnections = db.serverConfig.allRawConnections().length;
    options['onAll'] = true;
  }

<<<<<<< HEAD
  // Return connection option
  options.returnConnection = true;

  // Execute nonce command
  db.command({'getnonce':1}, options, function(err, result, connection) {
    // Execute on all the connections
    if(err == null) {
      // Nonce used to make authentication request with md5 hash
      var nonce = result.nonce;

      // Use node md5 generator
      var md5 = crypto.createHash('md5');
      // Generate keys used for authentication
      md5.update(username + ":mongo:" + password);
      var hash_password = md5.digest('hex');
      // Final key
      md5 = crypto.createHash('md5');
      md5.update(nonce + username + hash_password);
      var key = md5.digest('hex');
      
      // Creat cmd
      var cmd = {'authenticate':1, 'user':username, 'nonce':nonce, 'key':key};

      // Execute command
      db.db(authdb).command(cmd, {connection:connection}, function(err, result) {
        // Count down
        numberOfConnections = numberOfConnections - 1;
        
        // Ensure we save any error
        if(err) { 
          errorObject = err;
        } else {
          credentialsValid = true;
          numberOfValidConnections = numberOfValidConnections + 1;
=======
  // Execute all four
  db._executeQueryCommand(DbCommand.createGetNonceCommand(db), options, function(err, result, connection) {
    // console.log("--------------------------------------------- MONGODB-CR 0")
    // console.dir(err)
    // Execute on all the connections
    if(err == null) {
      // Nonce used to make authentication request with md5 hash
      var nonce = result.documents[0].nonce;
      // Execute command
      db._executeQueryCommand(DbCommand.createAuthenticationCommand(db, username, password, nonce, authdb), {connection:connection}, function(err, result) {
        // console.log("--------------------------------------------- MONGODB-CR 1")
        // console.dir(err)
        // console.dir(result)
        // Count down
        numberOfConnections = numberOfConnections - 1;
        // Ensure we save any error
        if(err) {
          errorObject = err;
        } else if(result 
          && Array.isArray(result.documents) 
          && result.documents.length > 0 
          && (result.documents[0].err != null || result.documents[0].errmsg != null)) {
            errorObject = utils.toError(result.documents[0]);
>>>>>>> ce8810f9c11abc01d5c480f77f8827e1e3635323
        }

        // Work around the case where the number of connections are 0
        if(numberOfConnections <= 0 && typeof callback == 'function') {
          var internalCallback = callback;
          callback = null;

<<<<<<< HEAD
          if(errorObject == null && credentialsValid) {
            db.serverConfig.auth.add('MONGODB-CR', db.databaseName, username, password, authdb);
            // Return callback
            internalCallback(errorObject, true);
          } else if(numberOfValidConnections > 0 && numberOfValidConnections != numberOfConnections
            && credentialsValid) {
              // One or more servers failed on auth (f.ex secondary hanging on foreground indexing)
              db.serverConfig.auth.add('MONGODB-CR', db.databaseName, username, password, authdb);
              // Return callback
              internalCallback(errorObject, true);
=======
          if(errorObject == null
              && result && Array.isArray(result.documents) && result.documents.length > 0
              && result.documents[0].ok == 1) {            // We authenticated correctly save the credentials
            db.serverConfig.auth.add('MONGODB-CR', db.databaseName, username, password, authdb);
            // Return callback
            internalCallback(errorObject, true);
>>>>>>> ce8810f9c11abc01d5c480f77f8827e1e3635323
          } else {
            internalCallback(errorObject, false);
          }
        }
      });
    }
<<<<<<< HEAD
  });
=======
  });  
>>>>>>> ce8810f9c11abc01d5c480f77f8827e1e3635323
}

exports.authenticate = authenticate;